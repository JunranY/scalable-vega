{"version":3,"file":"vega-transform-db.modern.js","sources":["../index.js"],"sourcesContent":["import { inherits, ingest, Transform } from \"vega\";\nconst querystring = require('querystring');\nconst http = require('http');\n\n/**\n * Queries data from a Postgres database.\n * @constructor\n * @param {object} params - The parameters for this operator.\n */\nexport default function VegaTransformPostgres(params) {\n  Transform.call(this, [], params);\n}\n\nVegaTransformPostgres.setHttpOptions = function (httpOptions) {\n  if (httpOptions) {\n    this._httpOptions = httpOptions;\n    return this;\n  }\n  return this._httpOptions;\n}\n\nVegaTransformPostgres.Definition = {\n  type: \"dbtransform\", // FixMe: make uppercase\n  metadata: { changes: true, source: true },\n  params: [\n    { name: \"relation\", type: \"string\", required: true }\n  ]\n};\n\nconst prototype = inherits(VegaTransformPostgres, Transform);\n\nprototype.transform = async function (params, pulse) {\n  console.log(this)\n  if (!VegaTransformPostgres._httpOptions) {\n    throw Error(\"Vega Transform Postgres http options missing. Assign it with setHttpOptions.\");\n  }\n  if (!this._query) {\n    throw Error(\"Internal error: this._query should be defined\");\n  }\n\n  //console.log(this.query(this._argval.ops[0]))\n\n  let result = [];\n  const postQuery = async function (query) {\n    const options = VegaTransformPostgres._httpOptions\n    const response = await fetch(options.url, {\n      method: options.method,\n      mode: options.mode,\n      headers: options.headers,\n      body: querystring.stringify({\n        query: query\n      })\n    });\n\n    // fetch wonâ€™t reject on HTTP error status even if the response\n    // is an HTTP 404 or 500. Instead, it will resolve normally with\n    // ok status set to false\n    if (response.ok)\n      return await response.json();\n    else {\n      // capture the error message\n      const err = await response.json();\n      throw Error(\n        (err.error + ': ' + err.message).replace(/(\\r\\n|\\n|\\r)/gm, \"\")\n      );\n    }\n  };\n\n  try {\n\n    this._sql = this._query(this, this._argval.from)\n    console.log(this._sql)\n\n    result = await postQuery(this._sql);\n  } catch (error) {\n    console.log(error);\n  }\n\n  result.forEach(ingest);\n  const out = pulse.fork(pulse.NO_FIELDS & pulse.NO_SOURCE);\n\n  out.rem = Array.isArray(this.value) ? this.value : [];\n  console.log(out)\n  if (this.__proto__.constructor.Definition.type === \"Extent\") {\n    // changing the result format for Extent transform\n    // [{min:10, max, 100}] -> [10, 100]\n    const temp = [result[0].min, result[0].max]\n    result = temp\n  }\n  this.value = out.add = out.source = result;\n\n\n  return out;\n}\n"],"names":["querystring","require","VegaTransformPostgres","params","Transform","call","this","setHttpOptions","httpOptions","_httpOptions","Definition","type","metadata","changes","source","name","required","inherits","transform","async","pulse","console","log","Error","_query","result","_sql","_argval","from","query","options","response","fetch","url","method","mode","headers","body","stringify","ok","json","err","error","message","replace","postQuery","forEach","ingest","out","fork","NO_FIELDS","NO_SOURCE","rem","Array","isArray","value","__proto__","constructor","min","max","add"],"mappings":"2DACA,MAAMA,EAAcC,QAAQ,wBAQJC,EAAsBC,GAC5CC,EAAUC,KAAKC,KAAM,GAAIH,GARdF,QAAQ,QAWrBC,EAAsBK,eAAiB,SAAUC,GAC/C,OAAIA,GACFF,KAAKG,aAAeD,aAGVC,cAGdP,EAAsBQ,WAAa,CACjCC,KAAM,cACNC,SAAU,CAAEC,SAAS,EAAMC,QAAQ,GACnCX,OAAQ,CACN,CAAEY,KAAM,WAAYJ,KAAM,SAAUK,UAAU,KAIhCC,EAASf,EAAuBE,GAExCc,UAAYC,eAAgBhB,EAAQiB,GAE5C,GADAC,QAAQC,IAAIhB,OACPJ,EAAsBO,aACzB,MAAMc,MAAM,gFAEd,IAAKjB,KAAKkB,OACR,MAAMD,MAAM,iDAKd,IAAIE,EAAS,GA0Bb,IAEEnB,KAAKoB,KAAOpB,KAAKkB,OAAOlB,KAAMA,KAAKqB,QAAQC,MAC3CP,QAAQC,IAAIhB,KAAKoB,MAEjBD,QA9BgBN,eAAgBU,GAChC,MAAMC,EAAU5B,EAAsBO,aAChCsB,QAAiBC,MAAMF,EAAQG,IAAK,CACxCC,OAAQJ,EAAQI,OAChBC,KAAML,EAAQK,KACdC,QAASN,EAAQM,QACjBC,KAAMrC,EAAYsC,UAAU,CAC1BT,MAAOA,MAOX,GAAIE,EAASQ,GACX,aAAaR,EAASS,OACnB,CAEH,MAAMC,QAAYV,EAASS,OAC3B,MAAMjB,OACHkB,EAAIC,MAAQ,KAAOD,EAAIE,SAASC,QAAQ,iBAAkB,MAUhDC,CAAUvC,KAAKoB,MAC9B,MAAOgB,GACPrB,QAAQC,IAAIoB,GAGdjB,EAAOqB,QAAQC,GACf,MAAMC,EAAM5B,EAAM6B,KAAK7B,EAAM8B,UAAY9B,EAAM+B,WAa/C,OAXAH,EAAII,IAAMC,MAAMC,QAAQhD,KAAKiD,OAASjD,KAAKiD,MAAQ,GACnDlC,QAAQC,IAAI0B,GACuC,WAA/C1C,KAAKkD,UAAUC,YAAY/C,WAAWC,OAIxCc,EADa,CAACA,EAAO,GAAGiC,IAAKjC,EAAO,GAAGkC,MAGzCrD,KAAKiD,MAAQP,EAAIY,IAAMZ,EAAIlC,OAASW,EAG7BuB"}